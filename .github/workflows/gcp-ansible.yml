name: Ansible with GCP Dynamic Inventory

on:
  workflow_dispatch:

jobs:
  ansible-gcp:
    runs-on: self-hosted  # or ubuntu-latest if it's cloud-managed

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Ansible & dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip python3-venv
          python3 -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          pip install ansible google-auth google-api-python-client
          ansible-galaxy collection install google.cloud

      - name: Set up GCP service account & config files
        run: |
          echo "${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}" > gcp-service-account.json

          cat <<EOF > gcp_inventory.yml
          plugin: gcp_compute
          projects:
            - galvanic-flame-466111-q8
          zones:
            - us-central1-c
          auth_kind: serviceaccount
          service_account_file: gcp-service-account.json
          hostnames:
            - name
          EOF


          cat <<EOF > ansible.cfg
          [defaults]
          inventory = ./gcp_inventory.yml
          host_key_checking = False

          [inventory]
          enable_plugins = gcp_compute
          EOF

      - name: Run Ansible playbook with GCP inventory
        run: |
          source venv/bin/activate
          ansible-inventory -i gcp_inventory.yml --graph
          ansible-playbook -i gcp_inventory.yml playbook.yml
